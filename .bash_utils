# -*- mode: shell-script -*-
# TODO: caffiene off + mute sound + kill-chrome-gpu + i-gpu + wifi off

# http://unix.stackexchange.com/a/9124
mkcd () {
    case "$1" in
        */..|*/../) cd -- "$1";; # that doesn't make any sense unless the directory already exists
        /*/../*) (cd "${1%/../*}/.." && mkdir -p "./${1##*/../}") && cd -- "$1";;
        /*) mkdir -p "$1" && cd "$1";;
        */../*) (cd "./${1%/../*}/.." && mkdir -p "./${1##*/../}") && cd "./$1";;
        ../*) (cd .. && mkdir -p "${1#.}") && cd "$1";;
        *) mkdir -p "./$1" && cd "./$1";;
    esac
}

git-push-origin() {
    git add . && git commit -m -- && git push origin
}

git-update-all() {
    for d in $(find . ! -name '.' -maxdepth 1 -type d) ; do cd "$d" ; git status ; git pull origin ; cd .. ; done
}

hg-update-all() {
    for d in $(find . -type d -maxdepth 1 -not -name '.*') ; do echo $d; cd $d; hg pull; hg update; cd ..; done
}

brew-up() {
    brew update ; brew upgrade ; brew cleanup
}

git-diff-stat() {
    git diff --color=always --stat=1024 "$@" | sort | cat
}

kill-chrome-gpu() {
    ps auxw | egrep -i chrom | egrep '\-\-type=\gpu\-process' | awk '{print $2}' | xargs -n 1 kill
}

fix-dns() {
    sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.mDNSResponder.plist
    sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.mDNSResponder.plist
}

fix-routes() {
    sudo networksetup -setv4off Wi-Fi
    sudo networksetup -setdhcp Wi-Fi
}

docker-env() {
    eval $(docker-machine env "$@")
}

docker-cleanup() {
    S=$(docker ps -a -q)
    if [[ $S = *[!\ ]* ]]; then
        docker rm "$S"
    fi
    S=$(docker images -q -f dangling=true)
    if [[ $S = *[!\ ]* ]]; then
        docker rmi "$S"
    fi
}

docker-bash() {
    docker exec --detach-keys 'ctrl-o,ctrl-d' -it "$@" bash
}

github-clone() {
    VARS=$(python -c \
           'import sys, re; (_, arg) = sys.argv; d = re.match(r"((http(s)?://)?(www\./)?github(\.com)?/)?(?P<user>[^/\.]+)/(?P<repo>[^/\.]+)(/.*)?", arg).groupdict(); print("%s %s" % (d["user"], d["repo"]))' "$@")
    RESULT=$?
    if [ $RESULT -ne 0 ] ; then
       return $RESULT
    fi
    USER=$(echo $VARS | awk '{print $1}')
    REPO=$(echo $VARS | awk '{print $2}')
    if [ ! -d "$USER" ] ; then
        mkdir "$USER" || {
            echo "Failed to make directory $USER"
            return 1
        }
    fi
    git clone "https://www.github.com/$USER/$REPO" "$USER/$REPO"
    RESULT=$?
    if [ $RESULT -ne 0 ] ; then
        return $RESULT
    fi
    cd "$USER/$REPO" || {
        return 1
    }
    return 0
}

wifi-on() {
    networksetup -setairportpower en0 on
}

wifi-off() {
    networksetup -setairportpower en0 off
}

caffeine-on() {
    osascript <<EOF
tell application "Caffeine"
    turn on
end tell
EOF
}

caffeine-off() {
    osascript <<EOF
tell application "Caffeine"
    turn off
end tell
EOF
}

sound-off() {
    osascript -e "set Volume 0"
}

guess-go-root() {
    sh -c 'set -e ; cd $(dirname $(which go)) ; cd $(dirname $(readlink $(which go))) ; cd ../libexec ; pwd'
}
